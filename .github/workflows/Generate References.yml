name: GenerateReferences

on:
  repository_dispatch:
    types: [game_version_update]
  schedule:
    - cron: "0 */8 * * *"
  workflow_dispatch:

env:
  # Disable the .NET logo in the console output.
  DOTNET_NOLOGO: true
  # Disable the .NET first time experience to skip caching NuGet packages and speed up the build.
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  # Disable sending .NET CLI telemetry to Microsoft.
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Setup
      uses: butr/actions-common-setup@v2.0
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
     
    - name: Setup .NET 5
      uses: actions/setup-dotnet@master
      with:
        dotnet-version: 5.x.x

    - name: Setup .NET 6
      uses: actions/setup-dotnet@master
      with:
        dotnet-version: 6.x.x

    - name: Setup .NET 7
      uses: actions/setup-dotnet@master
      with:
        dotnet-version: 7.x.x

    - name: Install Tools
      run: >-
          dotnet tool install -g JetBrains.Refasmer.CliTool;
          dotnet tool install -g FetchBannerlordVersion;

    - name: Run Bannerlord.ReferenceAssemblies
      run: dotnet run --project src/Bannerlord.ReferenceAssemblies/Bannerlord.ReferenceAssemblies.csproj --configuration Debug --steamLogin ${{secrets.STEAM_LOGIN}} --steamPassword ${{secrets.STEAM_PASSWORD}} --steamAppId 261550 --steamOS windows --steamOSArch 64 --steamDepotId 261551 261552 --packageBaseName Bannerlord.ReferenceAssemblies --feedUrl https://nuget.pkg.github.com/BUTR/index.json --feedUser Aragas --feedPassword ${{secrets.GITHUB_TOKEN}}

    - name: Check files
      id: check_files
      run: echo "::set-output name=files_exists::$([[ "$(ls -A ./src/Bannerlord.ReferenceAssemblies/bin/Debug/net6.0/final)" ]] && echo "true" || echo "false")"
      shell: bash
    
    - name: Push to NuGet
      if: steps.check_files.outputs.files_exists == 'true'
      run: dotnet nuget push "./src/Bannerlord.ReferenceAssemblies/bin/Debug/net6.0/final/*.nupkg" --skip-duplicate -k ${{secrets.NUGET_API_KEY}} -s https://www.nuget.org
      shell: pwsh

    - name: Push to GPR
      if: steps.check_files.outputs.files_exists == 'true'
      run: |
           for f in ./src/Bannerlord.ReferenceAssemblies/bin/Debug/net6.0/final/*.nupkg
           do
             curl -vX PUT -u "vslee:${{secrets.GITHUB_TOKEN}}" -F package=@$f https://nuget.pkg.github.com/BUTR/
           done
      shell: bash
      
    - name: Dispatch
      uses: guilouro/multiple-repositories-dispatch@master
      if: steps.check_files.outputs.files_exists == 'true'
      with:
        repo_token: ${{secrets.REPO_ACCESS_TOKEN}}
        repositories: |
          BUTR/Bannerlord.ReferenceAssemblies.Documentation
          BUTR/Bannerlord.UIExtenderEx
          BUTR/Bannerlord.ButterLib
          Aragas/Bannerlord.MBOptionScreen
          BUTR/Bannerlord.BUTRLoader
          BUTR/Bannerlord.BUTR.Shared
          BUTR/Bannerlord.ReferenceAssemblies.Diff
          BUTR/AssemblyDiffer
        event_type: game_version_update_patch
        client_payload: '{"github": ${{ toJson(github) }}}'