name: GenerateReferences

on:
  repository_dispatch:
    types: [game_version_update]
  schedule:
    - cron: "0 */8 * * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  # Disable the .NET logo in the console output.
  DOTNET_NOLOGO: true
  # Disable the .NET first time experience to skip caching NuGet packages and speed up the build.
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  # Disable sending .NET CLI telemetry to Microsoft.
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Setup
      uses: butr/actions-common-setup@v2
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.x.x

    - name: Install Tools
      run: >-
        dotnet tool install -g FetchBannerlordVersion.Tool;
        dotnet tool install -g BepInEx.AssemblyPublicizer.Cli;

    - name: Remove NuGet sources
      run: |
        dotnet nuget list source;
        dotnet nuget remove source nuget.org;
        dotnet nuget remove source butr.github;

    - name: Run Bannerlord.ReferenceAssemblies
      run: dotnet run --project src/Bannerlord.ReferenceAssemblies/Bannerlord.ReferenceAssemblies.csproj --configuration Release --steamLogin ${{secrets.STEAM_LOGIN}} --steamPassword ${{secrets.STEAM_PASSWORD}} --steamAppId 261550 --steamOS windows --steamOSArch 64 --steamDepotId 261551 261552 --steamDLCAppId 2927200 --feedUrl https://api.nuget.org/v3/index.json;

    - name: Check files
      id: check_files
      run: echo "files_exists=$(if [ -d ./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final ] && [ "$(ls -A ./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final)" ]; then echo 'true'; else echo 'false'; fi)" >> "$GITHUB_OUTPUT"
      shell: bash

    - name: Upload NuGet packages
      if: steps.check_files.outputs.files_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final/*.nupkg

    - name: Remove NuGet sources
      if: steps.check_files.outputs.files_exists == 'true'
      run: |
        dotnet nuget list source;
        dotnet nuget remove source nuget.org;
        dotnet nuget remove source butr.github;

    - name: Push to NuGet
      if: steps.check_files.outputs.files_exists == 'true'
      run: |
        dotnet nuget add source https://api.nuget.org/v3/index.json --name NuGet
        dotnet nuget push "./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final/*.nupkg" --skip-duplicate --api-key "${{ secrets.NUGET_API_KEY }}" --source NuGet

    - name: Push to GPR
      if: steps.check_files.outputs.files_exists == 'true'
      run: |
        dotnet nuget add source https://nuget.pkg.github.com/BUTR/index.json --name GitHub --username BUTR --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text
        dotnet nuget push "./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final/*.nupkg" --skip-duplicate --source GitHub

    - name: Sleep for 10 minutes
      if: steps.check_files.outputs.files_exists == 'true'
      run: Start-Sleep -s 600
      shell: pwsh

    - uses: BUTR/.github/.github/actions/dispatch-game-update@master
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
