name: GenerateReferences

on:
  repository_dispatch:
    types: [game_version_update]
  schedule:
    - cron: "0 */8 * * *"
  workflow_dispatch:

env:
  # Disable the .NET logo in the console output.
  DOTNET_NOLOGO: true
  # Disable the .NET first time experience to skip caching NuGet packages and speed up the build.
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  # Disable sending .NET CLI telemetry to Microsoft.
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Setup
      uses: butr/actions-common-setup@v2
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.x.x

    - name: Install Tools
      run: >-
        dotnet tool install -g FetchBannerlordVersion.Tool;
        dotnet tool install -g BepInEx.AssemblyPublicizer.Cli;

    - name: Run Bannerlord.ReferenceAssemblies
      run: dotnet run --project src/Bannerlord.ReferenceAssemblies/Bannerlord.ReferenceAssemblies.csproj --configuration Release --steamLogin ${{secrets.STEAM_LOGIN}} --steamPassword ${{secrets.STEAM_PASSWORD}} --steamAppId 261550 --steamOS windows --steamOSArch 64 --steamDepotId 261551 261552 --steamDLCAppId 2927200 --feedUrl https://api.nuget.org/v3/index.json;

    - name: Check files
      id: check_files
      run: echo "files_exists=$(if [ -d ./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final ] && [ "$(ls -A ./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final)" ]; then echo 'true'; else echo 'false'; fi)" >> "$GITHUB_OUTPUT"
      shell: bash

    - name: Upload NuGet packages
      if: steps.check_files.outputs.files_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final/*.nupkg

    - name: Push to NuGet
      if: steps.check_files.outputs.files_exists == 'true'
      run: |
        for i in {1..3}; do
          dotnet nuget push "./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final/*.nupkg" --skip-duplicate -k ${{ secrets.NUGET_KEY }} -s https://www.nuget.org && break
          echo "Attempt $i failed, retrying in 30s..."
          sleep 30
        done

    - name: Push to GPR
      if: steps.check_files.outputs.files_exists == 'true'
      run: |
           for f in ./src/Bannerlord.ReferenceAssemblies/bin/Release/net9.0/final/*.nupkg
           do
             curl -vX PUT -u "BUTR:${{secrets.GITHUB_TOKEN}}" -F package=@$f https://nuget.pkg.github.com/BUTR/
           done
      shell: bash

    - name: Sleep for 10 minutes
      if: steps.check_files.outputs.files_exists == 'true'
      run: Start-Sleep -s 600
      shell: pwsh

    - uses: BUTR/.github/.github/actions/dispatch-game-update@master
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
